name: Build and Deploy Fullstack

on:
  push:
    branches:
      - main

jobs:
  # --- 後端任務 ---
  build-and-push-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: maeveyang/python-backend:latest

  # --- 前端任務 (新增的部分) ---
  build-and-push-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend # 指向您的前端資料夾
          push: true
          tags: maeveyang/frontend:latest

  # --- 部署任務 (等待前後端都完成後執行) ---
  deploy-to-k8s:
    needs: [build-and-push-backend, build-and-push-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > ~/.kube/config

      - name: Deploy to Kubernetes
        run: |
          # 同時部署後端與前端的 YAML
          kubectl apply -f k8s/backend-deployment.yaml --insecure-skip-tls-verify
          kubectl apply -f k8s/frontend-deployment.yaml --insecure-skip-tls-verify

          # 重啟部署以確保使用最新 Image
          kubectl rollout restart deployment/backend-deployment --insecure-skip-tls-verify
          kubectl rollout restart deployment/frontend-deployment --insecure-skip-tls-verify
